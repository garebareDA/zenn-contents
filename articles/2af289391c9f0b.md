---
title: "Rails„ÅßSeed„ÇíÂÆüË°å„Åô„ÇãÈ†ÜÁï™„ÇíÂÆö„ÇÅ„Å¶„Åè„Çå„Çã„Çπ„ÇØ„É™„Éó„Éà„ÇíËÄÉ„Åà„Çã"
emoji: "ü¶Å"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["ruby", "rails"]
published: false
publication_name: "smartcamp"
---

# ÊñπÊ≥ï
Application Record„ÅÆ„É™„É¨„Éº„Ç∑„Éß„É≥„Å´Âæì„Å£„Å¶„ÉÜ„Éº„Éñ„É´„Çí„Éà„Éù„É≠„Ç∏„Ç´„É´„ÇΩ„Éº„Éà„ÇíË°å„Åà„Å∞Seed„ÇíÂÆüË°å„Åô„ÇãÈ†ÜÁï™„ÇíÂÆö„ÇÅ„Çâ„Çå„Çã„ÅÆ„Åß„ÅØ„Å®„ÅÑ„ÅÜËÄÉ„Åà„ÅÆÂÖÉ„Çø„Çπ„ÇØ„ÇíÂÆüË£Ö„Åó„Åæ„Åó„Åü„ÄÇ

# ÂâçÊèê
Seed„ÅØ„ÉÜ„Éº„Éñ„É´„Åî„Å®„Å´ÂÆüË°å„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ

# „Éà„Éù„É≠„Ç∏„Ç´„É´„ÇΩ„Éº„Éà„Å®„ÅØ
ÊúâÂêëÈùûÂ∑°Âõû„Ç∞„É©„Éï„ÅÆÂêÑ„Éé„Éº„Éâ„ÇíÈ†ÜÂ∫è‰ªò„Åë„Åó„Å¶„ÄÅ„Å©„ÅÆ„Éé„Éº„Éâ„ÇÇÂá∫ÂäõËæ∫„ÅÆÂÖà„Å´„Éé„Éº„Éâ„Çà„ÇäÂâç„Å´Êù•„Çã„Çà„ÅÜ„Å´‰∏¶„Åπ„Çã„Åì„Å®„Åß„Åô„ÄÇ
Ruby„Åß„ÅØÊ®ôÊ∫ñ„É©„Ç§„Éñ„É©„É™„Å´„Éà„Éù„É≠„Ç∏„Ç´„É´„ÇΩ„Éº„Éà„Åå„ÅÇ„Çã„Åü„ÇÅ„Åù„Çå„Çí‰Ωø„Å£„Å¶ÂÆüË£Ö„Åô„Çã‰∫ã„Åå„Åß„Åç„Åæ„Åô„ÄÇ
Hash„Å´TSort„Çíinclude„Åô„Çã„Åì„Å®„Å´„Çà„Å£„Å¶ÂÆüË£Ö„Åå„Åß„Åç„Åæ„Åô„ÄÇ
https://docs.ruby-lang.org/ja/latest/library/tsort.html

```ruby
require 'tsort'

class Hash
  include TSort
  alias tsort_each_node each_key
  def tsort_each_child(node, &)
    fetch(node).each(&)
  end
end

{1=>[2, 3], 2=>[3], 3=>[], 4=>[]}.tsort
#=> [3, 2, 1, 4]
```

# Rake„Çø„Çπ„ÇØ„ÅÆÂÆüË£Ö

```ruby
require 'tsort'

class Hash
  include TSort
  alias tsort_each_node each_key
  def tsort_each_child(node, &)
    fetch(node).each(&)
  end
end

namespace :sort do
  task apply: :environment do
    Rails.application.eager_load!
    base = ActiveRecord::Base.descendants
                             .select { |k| !k.abstract_class? }
                             .flat_map { |k| k.reflect_on_all_associations }
                             .uniq
                             .filter do |r|
      r.is_a?(ActiveRecord::Reflection::AssociationReflection) && r.is_a?(ActiveRecord::Reflection::BelongsToReflection) && !r.polymorphic?
    end

    sort = {}
    base.each do |r|
      sort[r.active_record.to_s.underscore].nil? && sort[r.active_record.to_s.underscore] = []
      sort[r.name.to_s.singularize].nil? && sort[r.name.to_s.singularize] = []
      sort[r.active_record.to_s.underscore] << r.name.to_s.singularize
    end

    puts sort.tsort
  end
end
```

Ëß£Ë™¨„Åó„Å¶„ÅÑ„Åç„Åæ„Åô

```ruby
Rails.application.eager_load!
```

‰∏ÄÊó¶„Åô„Åπ„Å¶„ÅÆ„É™„É¨„Éº„Ç∑„Éß„É≥„Çí„Åì„Åì„ÅßË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô

```ruby
ActiveRecord::Base.descendants
                         .select { |k| !k.abstract_class? }
                         .flat_map { |k| k.reflect_on_all_associations }
```

ÂÖ®„Å¶„ÅÆActiveRecord„ÇØ„É©„Çπ„ÇíÂàóÊåô„Åó„Å¶„ÄÅ„Åô„Åπ„Å¶„ÅÆ„Çµ„Éñ„ÇØ„É©„Çπ„ÅÆÈñ¢ÈÄ£„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

```ruby
      .filter do |r|
      r.is_a?(ActiveRecord::Reflection::AssociationReflection) && r.is_a?(ActiveRecord::Reflection::BelongsToReflection) && !r.polymorphic?
```

`has_one` `has_many`Èñ¢ÈÄ£„ÅÆ„Åø„Çífilter„ÅßÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

```ruby
    sort = {}
    base.each do |r|
      sort[r.active_record.to_s.underscore].nil? && sort[r.active_record.to_s.underscore] = []
      sort[r.name.to_s.singularize].nil? && sort[r.name.to_s.singularize] = []
      sort[r.active_record.to_s.underscore] << r.name.to_s.singularize
    end
```

„ÉÜ„Éº„Éñ„É´„ÅÆÈñ¢ÈÄ£„Çí„Éè„ÉÉ„Ç∑„É•„Å´„Åó„Å¶ÈÖçÂàó„ÅßÈñ¢ÈÄ£„ÇíË°®Áèæ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

```ruby
puts sort.tsort
```

ÊúÄÂæå„Å´„Éà„Éù„É≠„Ç∏„Éº„ÇΩ„Éº„Éà„ÇíË°å„ÅÑÈ†ÜÂ∫è‰ªò„Åë„Åï„Çå„Åü„ÇÇ„ÅÆ„ÇíÂèñÂæó„Åó„Å¶Âá∫Âäõ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
Âá∫Âäõ„Åï„Çå„Åü„ÇÇ„ÅÆ„Å´Âæì„Å£„Å¶seed„ÇíÂÆüË°å„Åó„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇ

# ÂèÇËÄÉ
https://en-jp.wantedly.com/companies/wantedly/post_articles/533776
https://docs.ruby-lang.org/ja/latest/library/tsort.html
https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%9D%E3%83%AD%E3%82%B8%E3%82%AB%E3%83%AB%E3%82%BD%E3%83%BC%E3%83%88#:~:text=%E3%83%88%E3%83%9D%E3%83%AD%E3%82%B8%E3%82%AB%E3%83%AB%E3%82%BD%E3%83%BC%E3%83%88%EF%BC%88%E8%8B%B1%3A%20topological%20sort,%E3%82%BD%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%80%82