---
title: "RBSã®Privateã®å‡¦ç†ã‚’è¿½ã£ã¦ã¿ã‚‹"
emoji: "ğŸ¼"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
publication_name: "smartcamp"
---

## Rubyã®Private

ã“ã„ã¤ã®ã“ã¨ã§ã™ã€‚åˆå­¦è€…ãªã®ã§å‹˜é•ã„ã—ã¦ã„ã¾ã—ãŸãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã¯ãªããƒ¡ã‚½ãƒƒãƒ‰ã‚‰ã—ã„â€¦â€¦ã€‚

```ruby
class MyClass
  def hoge
    puts 'test'
  end

  private <--ã“ã„ã¤
  def hogehoge
  end
end
```

ã“ã®`Class`å†…ã«ã‚ã‚‹`private`ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã¯ãªããƒ¡ã‚½ãƒƒãƒ‰ãªã®ã§ã§å®Ÿéš›ã«å®šç¾©ã‚’è¦‹ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ä¸¦ã³ã«`public`ã‚‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã¯ãªããƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

## privateã®ä¸­èº«

```ruby
# rbs/prototype/rb.rb

 def private
  @private ||= AST::Members::Private.new(location: nil)
 end

 def public
  @public ||= AST::Members::Public.new(location: nil)
 end
```

ã©ã†ã‚„ã‚‰privateã®ä¸­èº«ã¯`@private`ãŒnilã®å ´åˆã«æ–°ã—ã„`AST::Member::Private`ã‚’`@private`ã«ä»£å…¥ã™ã‚‹é–¢æ•°ã®ã‚ˆã†ã§ã™ã€‚
`private`é–¢æ•°ãŒäºŒåº¦å‘¼ã°ã‚Œã¦ã‚‚`@private`ãŒåˆæœŸåŒ–ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚
ã“ã‚ŒãŒã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚’æ±ºå®šã™ã‚‹å‡¦ç†ã‹ã¨æ€ã£ãŸã‚“ã§ã™ã‘ã©ãã†ã„ã†ã‚ã‘ã§ã¯ãªã„ã‚ˆã†ã§ã™ã€‚

## å†…éƒ¨ã§privateé–¢æ•°ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹å ´æ‰€

é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹rb.rbå†…ã§`private`é–¢æ•°ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã®ã¯ä»¥ä¸‹ã§ã™ã€‚

```ruby
# rbs/prototype/rb.rb
def current_accessibility(decls, index = decls.size)
  slice = decls.slice(0, index) or raise
  idx = slice.rindex { |decl| decl == private || decl == public }
  if idx
    _ = decls[idx]
  else
    public
  end
end
```

```ruby
# rbs/prototype/rb.rb
def is_accessibility?(decl)
  decl == public || decl == private
end
```

é–¢æ•°åã‹ã‚‰ã—ã¦ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®å–å¾—ã¨ç¾åœ¨ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãŒã‚ã‚‹ã‹ã©ã†ã‹åˆ¤æ–­ã™ã‚‹é–¢æ•°ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

## å®Ÿéš›ã«é–¢æ•°ã‚’privateã«ã—ã¦ã„ã‚‹ç®‡æ‰€

```ruby
# rbs/prototype/rb.rb
def process(node, decls:, comments:, context:)
case node.type
...
when :public, :private
  accessibility = __send__(node.children[0])
  if args.empty?
    decls << accessibility
  else
    args.each do |arg|
      if arg && (name = literal_to_symbol(arg))
        if (i, _ = find_def_index_by_name(decls, name))
          current = current_accessibility(decls, i)
          if current != accessibility
            decls.insert(i + 1, current)
            decls.insert(i, accessibility)
          end
        end
      end
    end
    # For `private def foo` syntax
    current = current_accessibility(decls)
    decls << accessibility
    process_children(node, decls: decls, comments: comments, context: context)
    decls << current
  end
...
```

Nodeã®ã‚¿ã‚¤ãƒ—ãŒ`private`é–¢æ•°ã§ã‚ã‚Œã°`decls`ã«ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãŒç™»éŒ²ã•ã‚Œã‚‹å‡¦ç†ã‚’è¡Œã£ã¦ã„ãã†ã§ã™ã€‚
