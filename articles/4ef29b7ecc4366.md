---
title: "RBSã®Privateã®å‡¦ç†ã‚’è¿½ã£ã¦ã¿ã‚‹"
emoji: "ğŸ¼"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['ruby']
published: true
publication_name: "smartcamp"
---

## Rubyã®Private

ã“ã„ã¤ã®ã“ã¨ã§ã™ã€‚åˆå­¦è€…ãªã®ã§å‹˜é•ã„ã—ã¦ã„ã¾ã—ãŸãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã¯ãªããƒ¡ã‚½ãƒƒãƒ‰ã‚‰ã—ã„â€¦â€¦ã€‚

```ruby
class MyClass
  def hoge
    puts 'test'
  end

  private <--ã“ã„ã¤
  def hogehoge
  end
end
```

### å…¬å¼ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

```plane
private() -> nil[permalink][rdoc][edit]
private(name) -> String | Symbol
private(*name) -> Array
private(names) -> Array
ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ private ã«è¨­å®šã—ã¾ã™ã€‚

å¼•æ•°ãªã—ã®ã¨ãã¯ä»Šå¾Œã“ã®ã‚¯ãƒ©ã‚¹ã¾ãŸã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®šç¾©å†…ã§æ–°è¦ã«å®šç¾©ã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’é–¢æ•°å½¢å¼ã§ã ã‘å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«(private)è¨­å®šã—ã¾ã™ã€‚

å¼•æ•°ãŒä¸ãˆã‚‰ã‚ŒãŸæ™‚ã«ã¯å¼•æ•°ã«ã‚ˆã£ã¦æŒ‡å®šã•ã‚ŒãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’ private ã«è¨­å®šã—ã¾ã™ã€‚

å¯è¦–æ€§ã«ã¤ã„ã¦ã¯ ã‚¯ãƒ©ã‚¹ï¼ãƒ¡ã‚½ãƒƒãƒ‰ã®å®šç¾©/å‘¼ã³å‡ºã—åˆ¶é™ ã‚’å‚ç…§ã—ã¦ä¸‹ã•ã„ã€‚
```

https://docs.ruby-lang.org/ja/latest/class/Module.html#I_PRIVATE

## rbs

rbsã§ã‚‚åŒæ§˜é–¢æ•°ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

``` ruby
  def private: () -> nil
             | (Symbol method_name) -> Symbol
             | (Symbol, Symbol, *Symbol method_name) -> Array[Symbol]
             | (string method_name) -> string
             | (interned, interned, *interned method_name) -> Array[interned]
             | (Array[interned]) -> Array[interned]
```

## RBSå†…éƒ¨ã§é–¢æ•°ã‚’privateã«ã—ã¦ã„ã‚‹ç®‡æ‰€

```ruby
# rbs/prototype/rb.rb
def process(node, decls:, comments:, context:)
case node.type
...
when :public, :private
  accessibility = __send__(node.children[0])
  if args.empty?
    decls << accessibility
  else
    args.each do |arg|
      if arg && (name = literal_to_symbol(arg))
        if (i, _ = find_def_index_by_name(decls, name))
          current = current_accessibility(decls, i)
          if current != accessibility
            decls.insert(i + 1, current)
            decls.insert(i, accessibility)
          end
        end
      end
    end
    # For `private def foo` syntax
    current = current_accessibility(decls)
    decls << accessibility
    process_children(node, decls: decls, comments: comments, context: context)
    decls << current
  end
...
```

ã©ã†ã‚„ã‚‰å¼•æ•°ãŒãªã„å ´åˆ`decls`ã«ãã®ã¾ã¾ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãŒç™»éŒ²ã•ã‚Œã€å¼•æ•°ã‚ã‚‹å ´åˆã¯é–¢æ•°ã‚’åå‰ã§æ¢ã—ã¦ç™»éŒ²ã€`def`ã®å‰ã®`private`ãŒã¤ã¦ã‚‹ã‚‚ã®ã¯åˆ¥é€”å‡¦ç†ã‚’ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
å˜ç´”ã«Nodeã®ã‚¿ã‚¤ãƒ—ãŒ`private`é–¢æ•°ã§ã‚ã‚Œã°`decls`ã«ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãŒç™»éŒ²ã•ã‚Œã‚‹å‡¦ç†ã‚’è¡Œã£ã¦ã„ãã†ã§ã™ã€‚

### current_accessibility

```ruby
# rbs/prototype/rb.rb
def current_accessibility(decls, index = decls.size)
  slice = decls.slice(0, index) or raise
  idx = slice.rindex { |decl| decl == private || decl == public }
  if idx
    _ = decls[idx]
  else
    public
  end
end
```

ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãŒä½•ãªã®ã‹ã‚’`rindex`ã‚’ä½¿ã„ã€`private`ã¾ãŸã¯`public`ãŒæœ€å¾Œã®ã©ã“ã§ã§ããŸã®ã‹ã‚’æ¢ç´¢ã—ã¦èª¿ã¹ã‚‹é–¢æ•°ã®ã‚ˆã†ã§ã™ã€‚
`process`ã®ä¸­ã§ã“ã‚Œã‚’ä½¿ã„ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚’æ›´æ–°ã™ã¹ãã‹ã©ã†ãŒåˆ¤æ–­ã—ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã­ã€‚

### private

```ruby
# rbs/prototype/rb.rb

 def private
  @private ||= AST::Members::Private.new(location: nil)
 end
```

`@private`ãŒnilã®å ´åˆã«æ–°ã—ã„`AST::Member::Private`ã‚’`@private`ã«ä»£å…¥ã™ã‚‹é–¢æ•°ã®ã‚ˆã†ã§ã™ã€‚
`@private`ã‚’ä¿æŒã—ã¦ã„ã‚‹ç†ç”±ã¯ä½¿ã£ã¦ã„ã‚‹å ´æ‰€ãŒè¦‹å½“ãŸã‚‰ãšèƒŒæ™¯ãŒã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚(åˆæœŸåŒ–ã«è² è·ãŒã‹ã‹ã‚‹ã‹ã‚‰ï¼Ÿ)

## ãŠã‚ã‚Š
`private`ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã¯ãªããƒ¡ã‚½ãƒƒãƒ‰ã ã£ãŸã®ã§ASTã®è§£æãŒã©ã†ãªã£ã¦ã‚‹ã‚“ã ã‚ã†ãªã¨æ€ã„å®Ÿè£…ã‚’è¿½ã£ã¦ã¿ã¾ã—ãŸï¼
é–“é•ã£ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã„ï¼ï¼