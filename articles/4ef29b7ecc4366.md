---
title: "RBSのPrivateの処理を追ってみる"
emoji: "🐼"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
publication_name: "smartcamp"
---

## RubyのPrivate

こいつのことです。初学者なので勘違いしていましたがキーワードではなくメソッドらしい……。

```ruby
class MyClass
  def hoge
    puts 'test'
  end

  private <--こいつ
  def hogehoge
  end
end
```

この`Class`内にある`private`はキーワードではなくメソッドなのでで実際に定義を見ることもできます。
並びに`public`もキーワードではなくメソッドです。

## privateの中身

```ruby
# rbs/prototype/rb.rb

 def private
  @private ||= AST::Members::Private.new(location: nil)
 end

 def public
  @public ||= AST::Members::Public.new(location: nil)
 end
```

どうやらprivateの中身は`@private`がnilの場合に新しい`AST::Member::Private`を`@private`に代入する関数のようです。
`private`関数が二度呼ばれても`@private`が初期化されないようにしているみたいです。
これがアクセシビリティを決定する処理かと思ったんですけどそういうわけではないようです。

## 内部でprivate関数が呼ばれている場所

関数が定義されているrb.rb内で`private`関数が呼ばれているのは以下です。

```ruby
# rbs/prototype/rb.rb
def current_accessibility(decls, index = decls.size)
  slice = decls.slice(0, index) or raise
  idx = slice.rindex { |decl| decl == private || decl == public }
  if idx
    _ = decls[idx]
  else
    public
  end
end
```

```ruby
# rbs/prototype/rb.rb
def is_accessibility?(decl)
  decl == public || decl == private
end
```

関数名からして現在のアクセシビリティの取得と現在アクセシビリティがあるかどうか判断する関数に使われているようです。

## 実際に関数をprivateにしている箇所

```ruby
# rbs/prototype/rb.rb
def process(node, decls:, comments:, context:)
case node.type
...
when :public, :private
  accessibility = __send__(node.children[0])
  if args.empty?
    decls << accessibility
  else
    args.each do |arg|
      if arg && (name = literal_to_symbol(arg))
        if (i, _ = find_def_index_by_name(decls, name))
          current = current_accessibility(decls, i)
          if current != accessibility
            decls.insert(i + 1, current)
            decls.insert(i, accessibility)
          end
        end
      end
    end
    # For `private def foo` syntax
    current = current_accessibility(decls)
    decls << accessibility
    process_children(node, decls: decls, comments: comments, context: context)
    decls << current
  end
...
```

Nodeのタイプが`private`関数であれば`decls`に現在のアクセシビリティが登録される処理を行っていそうです。
