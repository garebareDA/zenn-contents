---
title: "Goでjsonパーサーを自作する"
emoji: "🦑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["go"]
published: false
publication_name: "smartcamp"
---
jsonのパーサーをgoで作成したので共有したいと思います。

# jsonの字句解析
 jsonの字句解析で行っていることを解説していきます。
```json
{"example": "text"}
```
例としてこのようなJSONがあったとします。
これを前から見ていき、条件によってトークンに分割していきます。

```go
["{", "example", ":", "text", "}"]
```
結果はこのような感じになります。
実際の実装では型でトークンを作成しています。

## 考え方
```json
{"example": "text"}
↑
```
カーソルを用意し前から順番に見ていきます。
最初が`{`であればオブジェクトなので`{`を配列に格納し次に`}`が来るまでカーソルを進めます

```json
{"example": "text"}
 ↑
```
`"`が取得された場合次の`"`まではstringなのでこのjsonの場合`example`を配列に格納します

```json
{"example": "text"}
          ↑
```
`:`が取得された場合はそのまま配列に格納します
`"text"`に関しては一つ前のものと同様です

```json
{"example": "text"}
                  ↑
```
最後に`}`を配列に格納すれば字句解析の完了です

### jsonのvalueがstring以外だった場合
```json
{"example": 12}
            ↑
```
このような場合はnumberとして扱う文字列を定義しておき、それにマッチするものはnumberとして扱います
numberとして扱うものは配列に格納時にInt型, Float型に変換しておきます

```json
{"example": true}
            ↑
```
またboolだった場合も同様に`true`と`false`にマッチするものはboolとして扱います
こちらも配列に格納時にBool型に変換しておきます

# jsonのパーサー
```go
["{", "example", ":", "text", "}"]
```
このようなトークン列を`[]map[string]interface{}`にします。

```go
map[example: text]
```
このような結果が得られます。

## 考え方
```go
["{", "example", ":", "text", "}"]
  ↑
```
カーソルを用意し前から順番に見ていきます。
最初が`{`だった場合はオブジェクトなのでmapを用意して次に`}`が来るまでカーソルを動かします。

```go
["{", "example", ":", "text", "}"]
          ↑
```
`example`は`:`の後の値ではないためjsonのkeyであることがわかります。なのでmapのkeyとして設定します。

```go
["{", "example", ":", "text", "}"]
                         ↑
```
`text`は`:`のあとに来ておりvalueであることが確定し`example`のvalueとして格納します。

```go
["{", "example", ":", "text", "}"]
                               ↑
```
最後にこれ以上配列に何も無いことを確認し、処理が終了となります。

### jsonのvalueが配列かオブジェクトだった場合
```go
["{", "example", ":", "{", "example2", ":", "text", "}"]
                       ↑
```
このようになっていた場合再度`{`を取得したタイミングで上記の一番最初の処理に戻り、オブジェクトとしてパースしていきます。

```go
["{", "example", ":", "[", 12, "text", "]"]
                       ↑
```
このような場合次の`]`が来るまで前から順番に配列に格納しmapのvalueに配列を格納します。
字句解析時点で型が変更されているため特別な処理必要としていません。

# リポジトリ
実際の実装はこちらです。
https://github.com/garebareDA/json-parser